<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mason Worx App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        body {
            background-color: #1a1a1a;
            color: #e0e0e0;
            line-height: 1.6;
            font-size: 16px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            display: none;
            background-color: #252525;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .section.active {
            display: block;
        }
        h1 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #ffffff;
        }
        h2 {
            font-size: 1.2rem;
            color: #ffffff;
            margin-bottom: 10px;
        }
        /* Navbar */
        .navbar {
            background-color: #2c2c2c;
            padding: 10px 15px;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .navbar img {
            height: 40px;
        }
        .navbar .menu-toggle {
            display: none;
            color: #e0e0e0;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .navbar ul {
            list-style: none;
            display: flex;
            justify-content: flex-end;
        }
        .navbar ul li {
            margin-left: 20px;
        }
        .navbar ul li a {
            color: #e0e0e0;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
        }
        .navbar ul li a:hover, .navbar ul li a.active {
            background-color: #3a3a3a;
            color: #f39c12;
        }
        /* Buttons */
        button {
            background-color: #f39c12;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background-color: #e08e0b;
        }
        /* Form Elements */
        input, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            background-color: #333;
            border: 1px solid #444;
            border-radius: 8px;
            color: #e0e0e0;
        }
        /* Autocomplete */
        .autocomplete-container {
            position: relative;
        }
        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #333;
            border: 1px solid #444;
            border-radius: 8px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
        }
        .autocomplete-suggestions div {
            padding: 10px;
            cursor: pointer;
        }
        .autocomplete-suggestions div:hover {
            background-color: #444;
        }
        /* Onboarding */
        .role-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .role-card {
            background-color: #333;
            padding: 15px;
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
        }
        .role-card:hover {
            background-color: #3a3a3a;
        }
        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .dashboard-card {
            background-color: #333;
            padding: 15px;
            border-radius: 12px;
        }
        /* Job Overview */
        .job-overview p {
            margin-bottom: 8px;
        }
        /* Weather */
        .weather {
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
            border-radius: 16px;
            padding: 10px;
        }
        .weather:hover {
            transform: scale(1.02);
        }
        .weather-summary {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px;
        }
        .weather-icon {
            font-size: 2rem;
            margin-right: 10px;
        }
        .weather-info {
            flex-grow: 1;
        }
        .weather-info strong {
            font-size: 1.5rem;
        }
        .refresh-icon {
            cursor: pointer;
            font-size: 1.2rem;
            color: #f39c12;
        }
        .refresh-icon:hover {
            color: #e08e0b;
        }
        .minute-forecast {
            margin: 10px 0;
        }
        .minute-forecast p {
            font-size: 0.9rem;
            color: #999;
            margin-bottom: 5px;
        }
        .minute-forecast-bars {
            display: flex;
            align-items: flex-end;
            height: 40px;
            overflow-x: auto;
            position: relative;
            gap: 2px;
        }
        .minute-bar {
            flex: 1;
            min-width: 8px;
            background-color: #4b6cb7;
            opacity: 0.6;
            position: relative;
        }
        .minute-bar-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: #999;
        }
        .hourly-forecast-8 {
            display: flex;
            overflow-x: auto;
            margin-top: 10px;
            padding-bottom: 5px;
        }
        .hourly-forecast-8 div {
            text-align: center;
            min-width: 60px;
            margin-right: 10px;
        }
        .weather-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
        }
        .weather-modal-content {
            background-color: #1a1a1a;
            margin: 5% auto;
            padding: 20px;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            position: relative;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        @media (max-width: 600px) {
            .weather-modal-content {
                max-width: 90%;
            }
        }
        .close-modal {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 2rem;
            color: #f39c12;
            cursor: pointer;
        }
        .close-modal:hover {
            color: #e08e0b;
        }
        .weather-current-detailed {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .weather-icon-large {
            font-size: 3rem;
            margin-right: 15px;
        }
        .forecast-day {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #333;
            cursor: pointer;
        }
        .forecast-day:last-child {
            border-bottom: none;
        }
        .forecast-day:hover {
            background-color: #333;
        }
        .forecast-day.bounce {
            animation: bounce 0.3s ease;
        }
        @keyframes bounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .temp-bar {
            flex-grow: 1;
            height: 8px;
            background: linear-gradient(to right, #4b6cb7, #f7b733);
            border-radius: 4px;
            position: relative;
            margin: 0 15px;
        }
        .temp-marker {
            position: absolute;
            top: -20px;
            font-size: 0.9rem;
            color: #999;
        }
        .temp-marker.low {
            left: 0;
        }
        .temp-marker.high {
            right: 0;
        }
        .forecast-details {
            display: none;
            padding: 10px;
            background-color: #2c2c2c;
            border-radius: 8px;
            margin-top: 5px;
        }
        .forecast-details.active {
            display: block;
        }
        .hourly-forecast {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding-bottom: 10px;
        }
        .hourly-forecast div {
            text-align: center;
            min-width: 80px;
            padding: 5px;
            background-color: #333;
            border-radius: 8px;
        }
        .live-tracking {
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
            border-radius: 16px;
            padding: 10px;
        }
        .live-tracking:hover {
            transform: scale(1.02);
        }
        .live-tracking-content {
            margin-top: 10px;
        }
        #live-tracking-map {
            width: 100%;
            background-color: #333;
            border-radius: 8px;
        }
        #live-tracking-map.expanded {
            height: 300px;
        }
        /* Calendar */
        .calendar {
            text-align: center;
        }
        .calendar .days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 10px;
        }
        .calendar .days div {
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
        }
        .calendar .days div:hover, .calendar .days div.event {
            background-color: #f39c12;
            color: #1a1a1a;
        }
        /* Tasks */
        .tasks ul {
            list-style: none;
        }
        .tasks li {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        /* Messages */
        .messages ul {
            list-style: none;
            max-height: 200px;
            overflow-y: auto;
        }
        .messages li {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .messages .avatar {
            width: 30px;
            height: 30px;
            background-color: #555;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .messages input {
            margin-bottom: 0;
        }
        /* Check-In */
        .check-in img {
            width: 100px;
            height: 100px;
            margin-top: 10px;
        }
        /* Job Intake Preview */
        .job-preview {
            margin-top: 20px;
            background-color: #333;
            padding: 15px;
            border-radius: 12px;
            display: none;
        }
        .job-preview.active {
            display: block;
        }
        .job-preview p {
            margin-bottom: 5px;
        }
        /* User Management */
        .user-management table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .user-management th, .user-management td {
            padding: 8px;
            border: 1px solid #444;
            text-align: left;
        }
        .user-management th {
            background-color: #3a3a3a;
        }
        /* Password Change Modal */
        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
        }
        .password-modal-content {
            background-color: #1a1a1a;
            margin: 5% auto;
            padding: 20px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .navbar .menu-toggle {
                display: block;
            }
            .navbar ul {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 60px;
                left: 0;
                width: 100%;
                background-color: #2c2c2c;
            }
            .navbar ul.active {
                display: flex;
            }
            .navbar ul li {
                margin: 10px 0;
                text-align: center;
            }
            .container {
                padding: 15px;
                margin-top: 60px;
            }
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .weather-forecast {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAAWjrhtwCMGuDGntEVvSZ7ng0m_IaWgXw&libraries=places"></script>
</head>
<body>
    <nav class="navbar">
        <img src="logo.png" alt="Mason Worx Logo">
        <span class="menu-toggle">☰</span>
        <ul id="navMenu">
            <li id="onboardingLink"><a href="#" data-section="onboarding">Onboarding</a></li>
            <li><a href="#" data-section="job-intake">Job Intake</a></li>
            <li><a href="#" data-section="dashboard" class="active">Dashboard</a></li>
            <li id="userManagementLink" style="display: none;"><a href="#" data-section="user-management">User Management</a></li>
        </ul>
    </nav>
    <div class="container">
        <!-- Onboarding Section -->
        <div id="onboarding" class="section">
            <h1>Welcome to Mason Worx</h1>
            <p>Enter your email and password to log in:</p>
            <input type="email" id="loginEmail" placeholder="Email" required>
            <input type="password" id="loginPassword" placeholder="Password" required>
            <button onclick="login()">Log In</button>
        </div>
        <!-- Job Intake Section -->
        <div id="job-intake" class="section">
            <h1>New Job Intake</h1>
            <form id="jobForm" onsubmit="submitJob(event)">
                <div class="autocomplete-container">
                    <input type="text" id="address" placeholder="Job Address" required oninput="suggestAddresses(this.value)">
                    <div id="addressSuggestions" class="autocomplete-suggestions"></div>
                </div>
                <input type="text" id="client" placeholder="Client Name" required>
                <input type="text" id="pocName" placeholder="Point of Contact Name">
                <input type="tel" id="pocPhone" placeholder="POC Phone">
                <input type="email" id="pocEmail" placeholder="POC Email">
                <select id="jobType" required>
                    <option value="">Select Job Type</option>
                    <option value="MW">MW (Masonry Work)</option>
                    <option value="MWS">MWS (Masonry + Site Work)</option>
                </select>
                <input type="file" id="plans" accept=".pdf,.jpg,.png">
                <button type="submit">Submit Job</button>
            </form>
            <div id="jobPreview" class="job-preview">
                <h2>Job Preview</h2>
                <p><strong>Address:</strong> <span id="previewAddress"></span></p>
                <p><strong>Client:</strong> <span id="previewClient"></span></p>
                <p><strong>POC:</strong> <span id="previewPoc"></span></p>
                <p><strong>Job Type:</strong> <span id="previewJobType"></span></p>
                <p><strong>Files:</strong> <span id="previewFiles"></span></p>
            </div>
        </div>
        <!-- Dashboard Section -->
        <div id="dashboard" class="section">
            <h1>Dashboard (<span id="dashboardRole">Admin</span>)</h1>
            <div class="dashboard-grid">
                <div class="dashboard-card job-overview">
                    <h2>Job Overview</h2>
                    <p><strong>MW497</strong><br>125 Main St, Somewhere, NY</p>
                    <p><strong>MW515</strong><br>458 Oak Ave, Another Town, NJ</p>
                </div>
                <div class="dashboard-card weather" onclick="openWeatherModal()">
                    <div class="weather-summary">
                        <span class="weather-icon" id="weather-icon"></span>
                        <div class="weather-info">
                            <strong id="weather-temp"></strong>
                            <span id="weather-condition"></span>, <span id="weather-location"></span>
                        </div>
                        <span class="refresh-icon" onclick="fetchWeather(event)">⟳</span>
                    </div>
                    <div class="minute-forecast" id="minute-forecast">
                        <p id="rain-start-message"></p>
                        <div class="minute-forecast-bars" id="minute-forecast-bars">
                            <!-- Minute-by-minute forecast bars will be populated dynamically -->
                        </div>
                    </div>
                    <div class="hourly-forecast-8" id="hourly-forecast-8">
                        <!-- 8-hour forecast will be populated dynamically -->
                    </div>
                </div>
                <div class="dashboard-card live-tracking" id="live-tracking-tile" style="display: none;">
                    <h2>Live Tracking</h2>
                    <div class="live-tracking-content">
                        <p id="live-tracking-status">Loading vehicles...</p>
                        <div id="live-tracking-map" style="height: 0; overflow: hidden; transition: height 0.3s ease;"></div>
                    </div>
                </div>
                <!-- Weather Modal -->
                <div class="weather-modal" id="weather-modal">
                    <div class="weather-modal-content">
                        <span class="close-modal" onclick="closeWeatherModal()">×</span>
                        <h2>Weather Details</h2>
                        <div class="weather-current-detailed">
                            <span class="weather-icon-large" id="weather-icon-modal"></span>
                            <div>
                                <strong id="weather-temp-modal"></strong><br>
                                <span id="weather-condition-modal"></span>, <span id="weather-location-modal"></span>
                            </div>
                        </div>
                        <div class="minute-forecast" id="minute-forecast-modal">
                            <h3>Next Hour Precipitation</h3>
                            <p id="rain-start-message-modal"></p>
                            <div class="minute-forecast-bars" id="minute-forecast-bars-modal">
                                <!-- Minute-by-minute forecast bars will be populated dynamically -->
                            </div>
                        </div>
                        <div class="weather-forecast" id="weather-forecast">
                            <!-- 10-day forecast will be populated dynamically -->
                        </div>
                    </div>
                </div>
                <div class="dashboard-card tasks">
                    <h2>Tasks</h2>
                    <ul id="taskList">
                        <li><input type="checkbox"> Review estimate for MW515</li>
                        <li><input type="checkbox"> Schedule site visit for new client</li>
                    </ul>
                    <div id="assignTaskForm" style="display: none;">
                        <h3>Assign Task</h3>
                        <select id="taskAssignee">
                            <option value="">Select User</option>
                        </select>
                        <input type="text" id="taskDescription" placeholder="Task Description">
                        <button onclick="assignTask()">Assign Task</button>
                    </div>
                </div>
                <div class="dashboard-card messages">
                    <h2>Messages</h2>
                    <select id="chatRecipient">
                        <option value="">Select Recipient</option>
                    </select>
                    <ul id="messageList"></ul>
                    <input type="text" id="messageInput" placeholder="Type a message...">
                    <button onclick="sendMessage()">Send</button>
                </div>
                <div class="dashboard-card check-in">
                    <h2>Laborer Check-In</h2>
                    <img src="https://via.placeholder.com/100?text=QR+Code" alt="QR Code">
                </div>
            </div>
        </div>
        <!-- User Management Section -->
        <div id="user-management" class="section">
            <h1>User Management</h1>
            <h2>Add New User</h2>
            <form id="addUserForm" onsubmit="addUser(event)">
                <input type="text" id="newUserName" placeholder="Full Name" required>
                <input type="email" id="newUserEmail" placeholder="Email" required>
                <input type="password" id="newUserTempPassword" placeholder="Temporary Password" required>
                <select id="newUserRole" required>
                    <option value="">Select Role</option>
                    <option value="Admin">Admin</option>
                    <option value="Foreman">Foreman</option>
                    <option value="Laborer">Laborer</option>
                </select>
                <button type="submit">Add User</button>
            </form>
            <h2>Existing Users</h2>
            <div class="user-management">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>First Login</th>
                        </tr>
                    </thead>
                    <tbody id="userList"></tbody>
                </table>
            </div>
        </div>
        <!-- Password Change Modal -->
        <div class="password-modal" id="passwordModal">
            <div class="password-modal-content">
                <h2>Change Password</h2>
                <p>You must change your password on first login.</p>
                <input type="password" id="newPassword" placeholder="New Password" required>
                <input type="password" id="confirmNewPassword" placeholder="Confirm New Password" required>
                <button onclick="changePassword()">Submit</button>
            </div>
        </div>
    </div>
    <script>
        // Global variables to store data
        let users = [];
        let messages = [];
        let tasks = [];

        // Simple password hashing (for demo purposes; use a proper library like bcrypt in production)
        function hashPassword(password) {
            return btoa(password); // Base64 encoding (not secure; for demo only)
        }

        function verifyPassword(password, hashed) {
            return hashPassword(password) === hashed;
        }

        // Fetch all data from Google Sheet
async function fetchSheetData() {
    try {
        const response = await fetch('/api/read-sheet');
        const data = await response.json();
        users = data.users || [];
        messages = data.messages || [];
        tasks = data.tasks || [];

        // If no users are found in the sheet, initialize with the admin user
        if (users.length === 0) {
            users = [
                { email: "alex@masonworxnj.com", password: hashPassword("Sendy0841!"), name: "Alex Kantor", role: "Admin", firstLogin: false }
            ];
            // Write the admin user to the sheet
            await writeSheetData('Users', ["alex@masonworxnj.com", hashPassword("Sendy0841!"), "Alex Kantor", "Admin", "false"]);
        }
    } catch (error) {
        console.error("Error fetching sheet data:", error);
        // Fallback to admin user if fetch fails
        users = [
            { email: "alex@masonworxnj.com", password: hashPassword("Sendy0841!"), name: "Alex Kantor", role: "Admin", firstLogin: false }
        ];
        messages = [];
        tasks = [];
    }
}

        // Write data to Google Sheet
        async function writeSheetData(sheet, data) {
            try {
                await fetch('/api/write-sheet', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ sheet, data })
                });
            } catch (error) {
                console.error("Error writing to sheet:", error);
            }
        }

        // Check if user is logged in
        const loggedInUser = localStorage.getItem('loggedInUser');
        const onboardingLink = document.getElementById('onboardingLink');
        const userManagementLink = document.getElementById('userManagementLink');
        const sections = document.querySelectorAll('.section');
        const navLinks = document.querySelectorAll('.navbar a');

        window.onload = async () => {
            await fetchSheetData();
            if (loggedInUser) {
                const user = users.find(u => u.email === loggedInUser);
                if (user) {
                    onboardingLink.style.display = 'none';
                    document.getElementById('dashboard').classList.add('active');
                    document.getElementById('dashboardRole').textContent = user.role;
                    navLinks.forEach(link => {
                        if (link.getAttribute('data-section') === 'dashboard') {
                            link.classList.add('active');
                        }
                    });
                    if (user.role === 'Admin') {
                        userManagementLink.style.display = 'block';
                    }
                    if (user.firstLogin) {
                        document.getElementById('passwordModal').style.display = 'block';
                    }
                    populateChatRecipients();
                    populateTaskAssignees();
                    displayMessages();
                    displayTasks();
                }
            } else {
                document.getElementById('onboarding').classList.add('active');
                navLinks.forEach(link => {
                    if (link.getAttribute('data-section') === 'onboarding') {
                        link.classList.add('active');
                    }
                });
            }
            fetchWeather();
            displayUsers();
        };

        // Login function
        function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const user = users.find(u => u.email === email && verifyPassword(password, u.password));

            if (user) {
                localStorage.setItem('loggedInUser', email);
                alert(`Welcome, ${user.name}!`);
                onboardingLink.style.display = 'none';
                sections.forEach(section => section.classList.remove('active'));
                navLinks.forEach(a => a.classList.remove('active'));
                document.getElementById('dashboard').classList.add('active');
                document.getElementById('dashboardRole').textContent = user.role;
                navLinks.forEach(link => {
                    if (link.getAttribute('data-section') === 'dashboard') {
                        link.classList.add('active');
                    }
                });
                if (user.role === 'Admin') {
                    userManagementLink.style.display = 'block';
                }
                if (user.firstLogin) {
                    document.getElementById('passwordModal').style.display = 'block';
                }
                populateChatRecipients();
                populateTaskAssignees();
                displayMessages();
                displayTasks();
            } else {
                alert('Invalid email or password.');
            }
        }

        // Change password on first login
        async function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            const email = localStorage.getItem('loggedInUser');

            if (newPassword !== confirmNewPassword) {
                alert('Passwords do not match.');
                return;
            }

            const user = users.find(u => u.email === email);
            if (user) {
                user.password = hashPassword(newPassword);
                user.firstLogin = false;
                await writeSheetData('Users', [email, user.password, user.name, user.role, user.firstLogin.toString()]);
                document.getElementById('passwordModal').style.display = 'none';
                alert('Password changed successfully.');
            }
        }

        // Navbar toggle for mobile
        const menuToggle = document.querySelector('.menu-toggle');
        const navMenu = document.querySelector('.navbar ul');
        menuToggle.addEventListener('click', () => {
            navMenu.classList.toggle('active');
        });

        // Section switching
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                sections.forEach(section => section.classList.remove('active'));
                navLinks.forEach(a => a.classList.remove('active'));
                const sectionId = link.getAttribute('data-section');
                document.getElementById(sectionId).classList.add('active');
                link.classList.add('active');
                if (window.innerWidth <= 768) navMenu.classList.remove('active');
            });
        });

        // Add new user
        async function addUser(event) {
            event.preventDefault();
            const name = document.getElementById('newUserName').value;
            const email = document.getElementById('newUserEmail').value;
            const tempPassword = document.getElementById('newUserTempPassword').value;
            const role = document.getElementById('newUserRole').value;

            if (users.find(u => u.email === email)) {
                alert('User with this email already exists.');
                return;
            }

            const newUser = {
                email: email,
                password: hashPassword(tempPassword),
                name: name,
                role: role,
                firstLogin: true
            };
            users.push(newUser);
            await writeSheetData('Users', [email, newUser.password, name, role, 'true']);

            console.log(`User invited: ${email} with temporary password: ${tempPassword}`);
            alert(`User ${name} (${email}) added successfully with role ${role}. Temporary password: ${tempPassword}`);

            displayUsers();
            document.getElementById('addUserForm').reset();
        }

        // Display users in the table
        function displayUsers() {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.role}</td>
                    <td>${user.firstLogin ? 'Yes' : 'No'}</td>
                `;
                userList.appendChild(row);
            });
        }

        // Address autocompletion
        const addressDatabase = [
            "123 Anywhere street Somewhere NJ, 12345",
            "458 Oak Ave, Another Town, NJ",
            "789 Pine Rd, Springfield, IL",
            "321 Elm St, New City, CA",
            "654 Birch Ln, Old Town, TX"
        ];
        function suggestAddresses(value) {
            const suggestions = document.getElementById('addressSuggestions');
            suggestions.innerHTML = '';
            if (!value) return;
            const matches = addressDatabase.filter(addr => addr.toLowerCase().includes(value.toLowerCase()));
            matches.forEach(addr => {
                const div = document.createElement('div');
                div.textContent = addr;
                div.onclick = () => {
                    document.getElementById('address').value = addr;
                    suggestions.innerHTML = '';
                };
                suggestions.appendChild(div);
            });
        }

        // Job intake submission
        async function submitJob(event) {
            event.preventDefault();
            const address = document.getElementById('address').value;
            const client = document.getElementById('client').value;
            const pocName = document.getElementById('pocName').value || 'N/A';
            const pocPhone = document.getElementById('pocPhone').value || 'N/A';
            const pocEmail = document.getElementById('pocEmail').value || 'N/A';
            const jobType = document.getElementById('jobType').value;
            const files = document.getElementById('plans').files;

            let fileData = null;
            let fileName = "None";
            let fileType = null;
            if (files.length > 0) {
                const file = files[0];
                fileName = file.name;
                fileType = file.type || "application/octet-stream";
                fileData = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });
            }

            console.log("File Name:", fileName);
            console.log("File Type:", fileType);
            console.log("File Data Length:", fileData ? fileData.length : "No data");
            console.log("File Data Preview:", fileData ? fileData.substring(0, 50) : "No data");

            const jobData = {
                address: address,
                client: client,
                pocName: pocName,
                pocPhone: pocPhone,
                pocEmail: pocEmail,
                jobType: jobType,
                fileName: fileName,
                fileType: fileType,
                fileData: fileData
            };

            document.getElementById('previewAddress').textContent = address;
            document.getElementById('previewClient').textContent = client;
            document.getElementById('previewPoc').textContent = `${pocName} (${pocPhone}, ${pocEmail})`;
            document.getElementById('previewJobType').textContent = jobType;
            document.getElementById('previewFiles').textContent = fileName;
            document.getElementById('jobPreview').classList.add('active');

            const scriptUrl = "/api/proxy";
            try {
                console.log("Submitting job data:", jobData);
                console.log("Sending request to:", scriptUrl);
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    body: JSON.stringify(jobData),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                console.log("Response status:", response.status);
                const result = await response.json();
                console.log("Response result:", result);
                if (result.status === "success") {
                    alert(`Job submitted: ${result.jobNumber} - ${client} at ${address}`);
                } else {
                    alert(`Error: ${result.message}`);
                }
            } catch (error) {
                console.error("Fetch error:", error);
                alert(`Error submitting job: ${error.message}`);
            }

            document.getElementById('jobForm').reset();
        }

        // Chat functionality
        function populateChatRecipients() {
            const chatRecipient = document.getElementById('chatRecipient');
            chatRecipient.innerHTML = '<option value="">Select Recipient</option>';
            const currentUser = localStorage.getItem('loggedInUser');
            users.forEach(user => {
                if (user.email !== currentUser) {
                    const option = document.createElement('option');
                    option.value = user.email;
                    option.textContent = user.name;
                    chatRecipient.appendChild(option);
                }
            });
        }

        async function sendMessage() {
            const recipient = document.getElementById('chatRecipient').value;
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!recipient || !message) {
                alert('Please select a recipient and enter a message.');
                return;
            }
            const sender = localStorage.getItem('loggedInUser');
            const senderUser = users.find(u => u.email === sender);
            const newMessage = {
                sender: sender,
                senderName: senderUser.name,
                recipient: recipient,
                message: message,
                timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            };
            messages.push(newMessage);
            await writeSheetData('Messages', [sender, senderUser.name, recipient, message, newMessage.timestamp]);
            input.value = '';
            displayMessages();
        }

        function displayMessages() {
            const messageList = document.getElementById('messageList');
            messageList.innerHTML = '';
            const currentUser = localStorage.getItem('loggedInUser');
            const recipient = document.getElementById('chatRecipient').value;
            const filteredMessages = messages.filter(msg =>
                (msg.sender === currentUser && msg.recipient === recipient) ||
                (msg.sender === recipient && msg.recipient === currentUser)
            );
            filteredMessages.forEach(msg => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="avatar">${msg.senderName[0]}</div>
                    <div>${msg.senderName}<br><small>${msg.timestamp}</small><br>${msg.message}</div>
                `;
                messageList.appendChild(li);
            });
            messageList.scrollTop = messageList.scrollHeight;
        }

        // Send message on Enter
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Task assignment functionality
        function populateTaskAssignees() {
            const taskAssignee = document.getElementById('taskAssignee');
            taskAssignee.innerHTML = '<option value="">Select User</option>';
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.email;
                option.textContent = user.name;
                taskAssignee.appendChild(option);
            });
            const currentUser = localStorage.getItem('loggedInUser');
            const user = users.find(u => u.email === currentUser);
            if (user && user.role === 'Admin') {
                document.getElementById('assignTaskForm').style.display = 'block';
            }
        }

        async function assignTask() {
            const assignee = document.getElementById('taskAssignee').value;
            const description = document.getElementById('taskDescription').value.trim();
            if (!assignee || !description) {
                alert('Please select an assignee and enter a task description.');
                return;
            }
            tasks.push({
                description: description,
                assignee: assignee
            });
            await writeSheetData('Tasks', [description, assignee]);
            document.getElementById('taskDescription').value = '';
            displayTasks();
        }

        function displayTasks() {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';
            const currentUser = localStorage.getItem('loggedInUser');
            const filteredTasks = tasks.filter(task => task.assignee === currentUser);
            filteredTasks.forEach(task => {
                const li = document.createElement('li');
                li.innerHTML = `<input type="checkbox"> ${task.description}`;
                taskList.appendChild(li);
            });
        }

        // Fetch and display real weather data
        async function fetchWeather(event) {
            if (event) event.stopPropagation();
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject);
                });
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;

                const response = await fetch(`/api/weather?lat=${latitude}&lon=${longitude}`);
                const data = await response.json();

                document.getElementById('weather-temp').textContent = `${data.current.temperature}°`;
                document.getElementById('weather-icon').textContent = data.current.icon;
                document.getElementById('weather-condition').textContent = data.current.condition;
                document.getElementById('weather-location').textContent = data.current.location;

                const weatherCard = document.querySelector('.weather');
                weatherCard.style.background = getGradientForCondition(data.current.condition);

                const minuteForecastContainer = document.getElementById('minute-forecast-bars');
                const maxPrecip = Math.max(...data.minuteForecast.map(m => m.precipitation), 0.1);
                minuteForecastContainer.innerHTML = data.minuteForecast.map(minute => `
                    <div class="minute-bar" style="height: ${(minute.precipitation / maxPrecip) * 100}%">
                        <span class="minute-bar-label">${minute.label}</span>
                    </div>
                `).join('');
                document.getElementById('rain-start-message').textContent = data.rainStartMessage;

                const hourly8Container = document.getElementById('hourly-forecast-8');
                hourly8Container.innerHTML = data.hourly8.map(hour => `
                    <div>
                        <div>${hour.time}</div>
                        <div>${hour.conditionIcon}</div>
                        <div>${hour.temp}°</div>
                    </div>
                `).join('');

                document.getElementById('weather-temp-modal').textContent = `${data.current.temperature}°`;
                document.getElementById('weather-icon-modal').textContent = data.current.icon;
                document.getElementById('weather-condition-modal').textContent = data.current.condition;
                document.getElementById('weather-location-modal').textContent = data.current.location;

                const minuteForecastModalContainer = document.getElementById('minute-forecast-bars-modal');
                minuteForecastModalContainer.innerHTML = data.minuteForecast.map(minute => `
                    <div class="minute-bar" style="height: ${(minute.precipitation / maxPrecip) * 100}%">
                        <span class="minute-bar-label">${minute.label}</span>
                    </div>
                `).join('');
                document.getElementById('rain-start-message-modal').textContent = data.rainStartMessage;

                const forecastContainer = document.getElementById('weather-forecast');
                forecastContainer.innerHTML = data.forecast.map((day, index) => `
                    <div class="forecast-day" onclick="toggleDayDetails(${index})">
                        <span>${day.dayName}</span>
                        <span class="weather-icon">${day.conditionIcon}</span>
                        <div class="temp-bar">
                            <span class="temp-marker low">${day.lowTemp}°</span>
                            <span class="temp-marker high">${day.highTemp}°</span>
                        </div>
                    </div>
                    <div class="forecast-details" id="day-details-${index}">
                        <h3>${day.dayName} Hourly Forecast</h3>
                        <div class="hourly-forecast">
                            ${day.hourly.map(hour => `
                                <div>
                                    <div>${hour.time}</div>
                                    <div>${hour.temp}° ${hour.conditionIcon}</div>
                                    <div>Precip: ${hour.precipitation}%</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error("Error fetching weather:", error);
                document.getElementById('weather-temp').textContent = "72°";
                document.getElementById('weather-icon').textContent = "☀️";
                document.getElementById('weather-condition').textContent = "Sunny";
                document.getElementById('weather-location').textContent = "Springfield, IL";
                document.getElementById('rain-start-message').textContent = "No rain in the next hour.";
                document.getElementById('minute-forecast-bars').innerHTML = '';
                document.getElementById('hourly-forecast-8').innerHTML = `
                    <div><div>4PM</div><div>☀️</div><div>72°</div></div>
                    <div><div>5PM</div><div>☀️</div><div>71°</div></div>
                    <div><div>6PM</div><div>☁️</div><div>70°</div></div>
                    <div><div>7PM</div><div>☁️</div><div>69°</div></div>
                    <div><div>8PM</div><div>🌙</div><div>68°</div></div>
                    <div><div>9PM</div><div>🌙</div><div>67°</div></div>
                    <div><div>10PM</div><div>🌙</div><div>66°</div></div>
                    <div><div>11PM</div><div>🌙</div><div>65°</div></div>
                `;
            }
        }

        // Toggle expandable day details and collapse others
        function toggleDayDetails(index) {
            event.stopPropagation();
            const hasHourlyData = index <= 1;
            if (!hasHourlyData) {
                const dayElement = document.querySelectorAll('.forecast-day')[index];
                dayElement.classList.add('bounce');
                return;
            }
            const allDetails = document.querySelectorAll('.forecast-details');
            allDetails.forEach((detail, i) => {
                if (i !== index) {
                    detail.classList.remove('active');
                }
            });
            const details = document.getElementById(`day-details-${index}`);
            details.classList.toggle('active');
        }

        // Open the weather modal
        function openWeatherModal() {
            document.getElementById('weather-modal').style.display = 'block';
        }

        // Close the weather modal
        function closeWeatherModal() {
            document.getElementById('weather-modal').style.display = 'none';
        }

        // Get gradient background based on weather condition
        function getGradientForCondition(condition) {
            switch (condition.toLowerCase()) {
                case "clear sky":
                    return "linear-gradient(135deg, #f7b733, #fc4a1a)";
                case "few clouds":
                case "scattered clouds":
                case "broken clouds":
                case "overcast clouds":
                    return "linear-gradient(135deg, #bdc3c7, #2c3e50)";
                case "light rain":
                case "moderate rain":
                case "heavy rain":
                case "rain":
                    return "linear-gradient(135deg, #4b6cb7, #182848)";
                case "thunderstorm":
                    return "linear-gradient(135deg, #2c3e50, #4b5e67)";
                default:
                    return "linear-gradient(135deg, #bdc3c7, #2c3e50)";
            }
        }

        // Fetch live tracking data (on hold)
        async function fetchLiveTracking() {
            try {
                const response = await fetch('/api/live-tracking');
                const data = await response.json();
                const statusElement = document.getElementById('live-tracking-status');
                if (!data.vehicles || data.vehicles.length === 0) {
                    statusElement.textContent = "No vehicles found.";
                    return;
                }
                statusElement.textContent = `${data.vehicles.length} vehicles online`;
                const mapElement = document.getElementById('live-tracking-map');
                if (mapElement.classList.contains('expanded')) {
                    const map = new google.maps.Map(mapElement, {
                        center: { lat: data.vehicles[0].latitude, lng: data.vehicles[0].longitude },
                        zoom: 10
                    });
                    data.vehicles.forEach(vehicle => {
                        new google.maps.Marker({
                            position: { lat: vehicle.latitude, lng: vehicle.longitude },
                            map: map,
                            title: `${vehicle.name} (${vehicle.status}, ${vehicle.speed} mph)`
                        });
                    });
                }
            } catch (error) {
                console.error("Error fetching live tracking:", error);
                document.getElementById('live-tracking-status').textContent = "Error loading vehicles.";
            }
        }

        function toggleLiveTrackingTile(event) {
            event.stopPropagation();
            const mapElement = document.getElementById('live-tracking-map');
            mapElement.classList.toggle('expanded');
            if (mapElement.classList.contains('expanded')) {
                fetchLiveTracking();
            }
        }

        document.getElementById('live-tracking-tile').addEventListener('click', toggleLiveTrackingTile);
    </script>
</body>
</html>