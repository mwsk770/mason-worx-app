<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mason Worx App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        body {
            background-color: #1a1a1a;
            color: #e0e0e0;
            line-height: 1.6;
            font-size: 16px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            display: none;
            background-color: #252525;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .section.active {
            display: block;
        }
        h1 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #ffffff;
        }
        h2 {
            font-size: 1.2rem;
            color: #ffffff;
            margin-bottom: 10px;
        }
        /* Navbar */
        .navbar {
            background-color: #2c2c2c;
            padding: 10px 15px;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .navbar img {
            height: 40px;
        }
        .navbar .menu-toggle {
            display: none;
            color: #e0e0e0;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .navbar ul {
            list-style: none;
            display: flex;
            justify-content: flex-end;
        }
        .navbar ul li {
            margin-left: 20px;
        }
        .navbar ul li a {
            color: #e0e0e0;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
        }
        .navbar ul li a:hover, .navbar ul li a.active {
            background-color: #3a3a3a;
            color: #f39c12;
        }
        /* Buttons */
        button {
            background-color: #f39c12;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background-color: #e08e0b;
        }
        /* Form Elements */
        input, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            background-color: #333;
            border: 1px solid #444;
            border-radius: 8px;
            color: #e0e0e0;
        }
        /* Autocomplete */
        .autocomplete-container {
            position: relative;
        }
        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #333;
            border: 1px solid #444;
            border-radius: 8px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
        }
        .autocomplete-suggestions div {
            padding: 10px;
            cursor: pointer;
        }
        .autocomplete-suggestions div:hover {
            background-color: #444;
        }
        /* Onboarding */
        .role-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .role-card {
            background-color: #333;
            padding: 15px;
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
        }
        .role-card:hover {
            background-color: #3a3a3a;
        }
        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .dashboard-card {
            background-color: #333;
            padding: 15px;
            border-radius: 12px;
        }
        /* Job Overview */
        .job-overview p {
            margin-bottom: 8px;
        }
        /* Weather */
        .weather {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .weather-current {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .weather-current .icon {
            font-size: 2rem;
        }
        .weather-forecast {
            display: flex;
            justify-content: space-between;
            gap: 5px;
        }
        .weather-forecast div {
            text-align: center;
            flex: 1;
        }
        /* Calendar */
        .calendar {
            text-align: center;
        }
        .calendar .days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 10px;
        }
        .calendar .days div {
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
        }
        .calendar .days div:hover, .calendar .days div.event {
            background-color: #f39c12;
            color: #1a1a1a;
        }
        /* Tasks */
        .tasks ul {
            list-style: none;
        }
        .tasks li {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        /* Messages */
        .messages ul {
            list-style: none;
            max-height: 100px;
            overflow-y: auto;
        }
        .messages li {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .messages .avatar {
            width: 30px;
            height: 30px;
            background-color: #555;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .messages input {
            margin-bottom: 0;
        }
        /* Check-In */
        .check-in img {
            width: 100px;
            height: 100px;
            margin-top: 10px;
        }
        /* Job Intake Preview */
        .job-preview {
            margin-top: 20px;
            background-color: #333;
            padding: 15px;
            border-radius: 12px;
            display: none;
        }
        .job-preview.active {
            display: block;
        }
        .job-preview p {
            margin-bottom: 5px;
        }
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .navbar .menu-toggle {
                display: block;
            }
            .navbar ul {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 60px;
                left: 0;
                width: 100%;
                background-color: #2c2c2c;
            }
            .navbar ul.active {
                display: flex;
            }
            .navbar ul li {
                margin: 10px 0;
                text-align: center;
            }
            .container {
                padding: 15px;
                margin-top: 60px;
            }
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .weather-forecast {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <img src="logo.png" alt="Mason Worx Logo">
        <span class="menu-toggle">☰</span>
        <ul id="navMenu">
            <li id="onboardingLink"><a href="#" data-section="onboarding">Onboarding</a></li>
            <li><a href="#" data-section="job-intake">Job Intake</a></li>
            <li><a href="#" data-section="dashboard" class="active">Dashboard</a></li>
        </ul>
    </nav>
    <div class="container">
        <!-- Onboarding Section -->
        <div id="onboarding" class="section">
            <h1>Welcome to Mason Worx</h1>
            <p>Select your role to get started:</p>
            <div class="role-grid">
                <div class="role-card" onclick="selectRole('Admin')">Admin</div>
                <div class="role-card" onclick="selectRole('Secondary Admin')">Secondary Admin</div>
                <div class="role-card" onclick="selectRole('Foreman')">Foreman</div>
                <div class="role-card" onclick="selectRole('Laborer')">Laborer</div>
                <div class="role-card" onclick="selectRole('Bookkeeper')">Bookkeeper</div>
            </div>
        </div>
        <!-- Job Intake Section -->
        <div id="job-intake" class="section">
            <h1>New Job Intake</h1>
            <form id="jobForm" onsubmit="submitJob(event)">
                <div class="autocomplete-container">
                    <input type="text" id="address" placeholder="Job Address" required oninput="suggestAddresses(this.value)">
                    <div id="addressSuggestions" class="autocomplete-suggestions"></div>
                </div>
                <input type="text" id="client" placeholder="Client Name" required>
                <input type="text" id="pocName" placeholder="Point of Contact Name">
                <input type="tel" id="pocPhone" placeholder="POC Phone">
                <input type="email" id="pocEmail" placeholder="POC Email">
                <select id="jobType" required>
                    <option value="">Select Job Type</option>
                    <option value="MW">MW (Masonry Work)</option>
                    <option value="MWS">MWS (Masonry + Site Work)</option>
                </select>
                <input type="file" id="plans" accept=".pdf,.jpg,.png">
                <button type="submit">Submit Job</button>
            </form>
            <div id="jobPreview" class="job-preview">
                <h2>Job Preview</h2>
                <p><strong>Address:</strong> <span id="previewAddress"></span></p>
                <p><strong>Client:</strong> <span id="previewClient"></span></p>
                <p><strong>POC:</strong> <span id="previewPoc"></span></p>
                <p><strong>Job Type:</strong> <span id="previewJobType"></span></p>
                <p><strong>Files:</strong> <span id="previewFiles"></span></p>
            </div>
        </div>
        <!-- Dashboard Section -->
        <div id="dashboard" class="section">
            <h1>Dashboard (Admin)</h1>
            <div class="dashboard-grid">
                <div class="dashboard-card job-overview">
                    <h2>Job Overview</h2>
                    <p><strong>MW497</strong><br>125 Main St, Somewhere, NY</p>
                    <p><strong>MW515</strong><br>458 Oak Ave, Another Town, NJ</p>
                </div>
<div class="dashboard-card weather">
    <h2>Weather</h2>
    <div class="weather-current">
        <span class="icon" id="weather-icon"></span>
        <div>
            <strong id="weather-temp"></strong><br>
            <span id="weather-condition"></span>, <span id="weather-location"></span>
        </div>
    </div>
    <div class="weather-forecast" id="weather-forecast">
        <!-- Forecast will be populated dynamically -->
    </div>
</div>
                <div class="dashboard-card tasks">
                    <h2>Tasks</h2>
                    <ul>
                        <li><input type="checkbox"> Review estimate for MW515</li>
                        <li><input type="checkbox"> Schedule site visit for new client</li>
                    </ul>
                </div>
                <div class="dashboard-card messages">
                    <h2>Messages</h2>
                    <ul id="messageList">
                        <li>
                            <div class="avatar">M</div>
                            <div>Mike Hirsch<br><small>2:15 PM</small><br>I’ve uploaded photos from today’s job site.</div>
                        </li>
                    </ul>
                    <input type="text" id="messageInput" placeholder="Type a message...">
                    <button onclick="sendMessage()">Send</button>
                </div>
                <div class="dashboard-card check-in">
                    <h2>Laborer Check-In</h2>
                    <img src="https://via.placeholder.com/100?text=QR+Code" alt="QR Code">
                </div>
            </div>
        </div>
    </div>
    <script>
        // Check if onboarding is complete
        const roleAssigned = localStorage.getItem('userRole');
        const onboardingLink = document.getElementById('onboardingLink');
        const sections = document.querySelectorAll('.section');
        const navLinks = document.querySelectorAll('.navbar a');

        if (roleAssigned) {
            onboardingLink.style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            navLinks.forEach(link => {
                if (link.getAttribute('data-section') === 'dashboard') {
                    link.classList.add('active');
                }
            });
        } else {
            document.getElementById('onboarding').classList.add('active');
            navLinks.forEach(link => {
                if (link.getAttribute('data-section') === 'onboarding') {
                    link.classList.add('active');
                }
            });
        }

        // Navbar toggle for mobile
        const menuToggle = document.querySelector('.menu-toggle');
        const navMenu = document.querySelector('.navbar ul');
        menuToggle.addEventListener('click', () => {
            navMenu.classList.toggle('active');
        });

        // Section switching
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                sections.forEach(section => section.classList.remove('active'));
                navLinks.forEach(a => a.classList.remove('active'));
                const sectionId = link.getAttribute('data-section');
                document.getElementById(sectionId).classList.add('active');
                link.classList.add('active');
                if (window.innerWidth <= 768) navMenu.classList.remove('active');
            });
        });

        // Role selection
        function selectRole(role) {
            localStorage.setItem('userRole', role);
            alert(`Role assigned: ${role}. Redirecting to Dashboard.`);
            onboardingLink.style.display = 'none';
            sections.forEach(section => section.classList.remove('active'));
            navLinks.forEach(a => a.classList.remove('active'));
            document.getElementById('dashboard').classList.add('active');
            navLinks.forEach(link => {
                if (link.getAttribute('data-section') === 'dashboard') {
                    link.classList.add('active');
                }
            });
        }

        // Address autocompletion
        const addressDatabase = [
            "123 Anywhere street Somewhere NJ, 12345",
            "458 Oak Ave, Another Town, NJ",
            "789 Pine Rd, Springfield, IL",
            "321 Elm St, New City, CA",
            "654 Birch Ln, Old Town, TX"
        ];
        function suggestAddresses(value) {
            const suggestions = document.getElementById('addressSuggestions');
            suggestions.innerHTML = '';
            if (!value) return;
            const matches = addressDatabase.filter(addr => addr.toLowerCase().includes(value.toLowerCase()));
            matches.forEach(addr => {
                const div = document.createElement('div');
                div.textContent = addr;
                div.onclick = () => {
                    document.getElementById('address').value = addr;
                    suggestions.innerHTML = '';
                };
                suggestions.appendChild(div);
            });
        }

        // Job intake submission
        async function submitJob(event) {
    event.preventDefault();
    const address = document.getElementById('address').value;
    const client = document.getElementById('client').value;
    const pocName = document.getElementById('pocName').value || 'N/A';
    const pocPhone = document.getElementById('pocPhone').value || 'N/A';
    const pocEmail = document.getElementById('pocEmail').value || 'N/A';
    const jobType = document.getElementById('jobType').value;
    const files = document.getElementById('plans').files;

    // Prepare file data (if a file is selected)
    let fileData = null;
    let fileName = "None";
    let fileType = null;
    if (files.length > 0) {
        const file = files[0];
        fileName = file.name;
        fileType = file.type || "application/octet-stream"; // Default to generic type if unknown
        fileData = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]); // Get base64 data (remove "data:image/jpeg;base64," prefix)
            reader.readAsDataURL(file);
        });
    }

    // Log the file details to check if it's being read correctly
    console.log("File Name:", fileName);
    console.log("File Type:", fileType);
    console.log("File Data Length:", fileData ? fileData.length : "No data");
    console.log("File Data Preview:", fileData ? fileData.substring(0, 50) : "No data");

    // Prepare job data
    const jobData = {
        address: address,
        client: client,
        pocName: pocName,
        pocPhone: pocPhone,
        pocEmail: pocEmail,
        jobType: jobType,
        fileName: fileName,
        fileType: fileType,
        fileData: fileData
    };

    // Update preview
    document.getElementById('previewAddress').textContent = address;
    document.getElementById('previewClient').textContent = client;
    document.getElementById('previewPoc').textContent = `${pocName} (${pocPhone}, ${pocEmail})`;
    document.getElementById('previewJobType').textContent = jobType;
    document.getElementById('previewFiles').textContent = fileName;
    document.getElementById('jobPreview').classList.add('active');

    // Send to Google Apps Script via proxy
    const scriptUrl = "/api/proxy";
    try {
        console.log("Submitting job data:", jobData);
        console.log("Sending request to:", scriptUrl);
        const response = await fetch(scriptUrl, {
            method: 'POST',
            body: JSON.stringify(jobData),
            headers: {
                'Content-Type': 'application/json'
            }
        });
        console.log("Response status:", response.status);
        const result = await response.json();
        console.log("Response result:", result);
        if (result.status === "success") {
            alert(`Job submitted: ${result.jobNumber} - ${client} at ${address}`);
        } else {
            alert(`Error: ${result.message}`);
        }
    } catch (error) {
        console.error("Fetch error:", error);
        alert(`Error submitting job: ${error.message}`);
    }

    document.getElementById('jobForm').reset();
}
        // Send message
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;
            const messageList = document.getElementById('messageList');
            const li = document.createElement('li');
            li.innerHTML = `
                <div class="avatar">A</div>
                <div>You<br><small>${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</small><br>${message}</div>
            `;
            messageList.appendChild(li);
            input.value = '';
            messageList.scrollTop = messageList.scrollHeight;
        }

        // Send message on Enter
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

  // Fetch and display real weather data
async function fetchWeather() {
    try {
        const response = await fetch(`/api/weather`);
        const data = await response.json();

        // Update current weather
        document.getElementById('weather-temp').textContent = `${data.current.temperature}°`;
        document.getElementById('weather-icon').textContent = data.current.icon;
        document.getElementById('weather-condition').textContent = data.current.condition;
        document.getElementById('weather-location').textContent = data.current.location;

        // Update 7-day forecast
        const forecastContainer = document.getElementById('weather-forecast');
        forecastContainer.innerHTML = data.forecast.map(day => `<div>${day}</div>`).join('');
    } catch (error) {
        console.error("Error fetching weather:", error);
        // Fallback to fake data if the API fails
        document.getElementById('weather-temp').textContent = "72°";
        document.getElementById('weather-icon').textContent = "☀️";
        document.getElementById('weather-condition').textContent = "Sunny";
        document.getElementById('weather-location').textContent = "Springfield, IL";
        document.getElementById('weather-forecast').innerHTML = `
            <div>Mon 70° ☀️</div>
            <div>Tue 68° 🌧️</div>
            <div>Wed 72° ☀️</div>
            <div>Thu 65° 🌧️</div>
            <div>Fri 70° ☁️</div>
            <div>Sat 73° ☀️</div>
            <div>Sun 71° ☁️</div>
        `;
    }
}

// Call fetchWeather when the page loads
window.addEventListener('load', fetchWeather);
  </script>
</body>
</html>